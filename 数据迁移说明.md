# 数据迁移说明

## 问题描述
之前的数据库中的数据默认是用户 `admin` 的数据。现在需要将这些数据关联到正确的用户。

## 解决方案

### 方案1：在LeanCloud控制台手动设置（推荐）

1. 登录 LeanCloud 控制台
2. 进入对应的数据表（Todolist、Diary、Blog、CalendarEvent）
3. 对于每个表：
   - 点击"数据"标签
   - 选择所有数据（或需要迁移的数据）
   - 点击"批量操作" → "更新字段"
   - 添加字段 `owner`，类型选择 `Pointer`，指向 `_User` 表
   - 值设置为 `admin` 用户的 ObjectId
   - 保存

### 方案2：使用代码迁移（需要管理员权限）

如果需要通过代码迁移，可以在浏览器控制台运行以下脚本：

```javascript
// 注意：这需要在已登录且有管理员权限的情况下运行
async function migrateDataToAdmin() {
    // 首先查找或创建 admin 用户
    const adminQuery = new AV.Query('_User');
    adminQuery.equalTo('username', 'admin');
    let adminUser = await adminQuery.first();
    
    if (!adminUser) {
        // 如果 admin 用户不存在，创建一个
        adminUser = new AV.User();
        adminUser.setUsername('admin');
        adminUser.setPassword('your-admin-password'); // 请修改密码
        await adminUser.signUp();
    }
    
    // 迁移 Todolist 数据
    const todoQuery = new AV.Query('Todolist');
    todoQuery.doesNotExist('owner');
    const todos = await todoQuery.find();
    for (let todo of todos) {
        todo.set('owner', adminUser);
        await todo.save();
    }
    console.log(`已迁移 ${todos.length} 条待办事项`);
    
    // 迁移 Diary 数据
    const diaryQuery = new AV.Query('Diary');
    diaryQuery.doesNotExist('owner');
    const diaries = await diaryQuery.find();
    for (let diary of diaries) {
        diary.set('owner', adminUser);
        await diary.save();
    }
    console.log(`已迁移 ${diaries.length} 条日记`);
    
    // 迁移 Blog 数据
    const blogQuery = new AV.Query('Blog');
    blogQuery.doesNotExist('owner');
    const blogs = await blogQuery.find();
    for (let blog of blogs) {
        blog.set('owner', adminUser);
        await blog.save();
    }
    console.log(`已迁移 ${blogs.length} 条博客`);
    
    // 迁移 CalendarEvent 数据
    const eventQuery = new AV.Query('CalendarEvent');
    eventQuery.doesNotExist('owner');
    const events = await eventQuery.find();
    for (let event of events) {
        event.set('owner', adminUser);
        await event.save();
    }
    console.log(`已迁移 ${events.length} 条日历事件`);
    
    console.log('迁移完成！');
}

// 运行迁移
migrateDataToAdmin().catch(console.error);
```

### 方案3：保持现状（如果不需要用户隔离）

如果所有数据都是共享的，不需要用户隔离，可以：
1. 保持 ACL 设置为所有人可读写（当前设置）
2. 不添加 `owner` 字段
3. 所有用户都可以查看和编辑所有数据

## 注意事项

1. **备份数据**：在执行任何迁移操作前，请先备份数据
2. **权限设置**：确保有足够的权限执行批量操作
3. **测试环境**：建议先在测试环境验证迁移脚本
4. **数据一致性**：迁移后检查数据是否完整

## 当前代码状态

当前代码已经：
- ✅ 修复了所有 JavaScript 语法错误
- ✅ 统一了 AV.init 初始化（避免重复初始化）
- ✅ 设置了 ACL 权限（所有人可读写）
- ✅ 添加了错误处理和调试信息

如果需要添加用户隔离功能，需要：
1. 在保存数据时添加 `owner` 字段
2. 在查询数据时过滤 `owner` 字段
3. 更新 ACL 权限设置
